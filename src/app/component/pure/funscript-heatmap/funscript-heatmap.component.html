<div class="flex flex-col w-full">
    <!-- Canvas Display Area -->
    <div class="relative"  [style.height]="canvasHeightPx + 'px'">
        <div class="absolute inset-0">
            <canvas class="w-full h-full" #heatmap></canvas>
        </div>
    </div>

    <!-- Control Bar -->
    <div class="flex flex-col mt-2  rounded-md p-2 shadow-sm">
        <!-- Top Control Bar -->
        <div class="sm:flex items-center justify-between mb-2">
            <!-- Toggle and Info -->
            <div class="pb-5 sm:pb-0 flex items-center space-x-3">
                <!-- Stats -->
                <div class="text-xs">
                    <span>
            {{ modifiedMetrics.actionCount }} actions | {{ formatTime(modifiedMetrics.duration) }}
          </span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center space-x-2">
                <button
                        class="text-sm px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-md transition-colors"
                        (click)="toggleControls()">
                    {{ showControls ? 'Hide Controls' : 'Show Controls' }}
                </button>

                <button
                        class="text-sm px-3 py-1 bg-red-500 hover:bg-red-600 text-white-700 rounded-md transition-colors"
                        (click)="resetToOriginal()">
                    Reset to Original Script
                </button>
            </div>
        </div>

        <!-- Expanded Controls (Conditional Display) -->
        <div *ngIf="showControls" class="rounded-md p-3 border border-zinc-700 shadow-sm transition-all">
            <!-- Tab Navigation -->
            <div class="flex border-b border-zinc-700 mb-4">
                <button
                        class="px-4 py-2 text-sm font-medium -mb-px transition-colors"
                        [class.text-blue-600]="activeTab === 'speed'"
                        [class.border-b-2]="activeTab === 'speed'"
                        [class.border-blue-500]="activeTab === 'speed'"
                        (click)="setActiveTab('speed')">
                    Speed
                </button>
                <button
                        class="px-4 py-2 text-sm font-medium -mb-px transition-colors"
                        [class.text-blue-600]="activeTab === 'position'"
                        [class.border-b-2]="activeTab === 'position'"
                        [class.border-blue-500]="activeTab === 'position'"
                        (click)="setActiveTab('position')">
                    Position
                </button>
                <button
                        class="px-4 py-2 text-sm font-medium -mb-px transition-colors"
                        [class.text-blue-600]="activeTab === 'offset'"
                        [class.border-b-2]="activeTab === 'offset'"
                        [class.border-blue-500]="activeTab === 'offset'"
                        (click)="setActiveTab('offset')">
                    Timing
                </button>
            </div>

            <!-- Speed Tab -->
            <div *ngIf="activeTab === 'speed'" class="space-y-4">
                <div>
                    <div class="mb-3 flex sm:block">
                        <button
                                class="px-4 py-2  bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors text-sm font-medium"
                                (click)="applySpeedLimit()">
                            Apply Speed Changes
                        </button>

                        <button
                                class="ml-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors text-sm font-medium"
                                (click)="applyHalfSpeed()">
                            Set Half Speed
                        </button>
                    </div>

                    <!-- Speed Limit Controls -->
                    <div class="flex items-center space-x-3 mb-2">
                        <label class="text-sm">Speed Limit:</label>
                        <select
                                [(ngModel)]="speedLimit"
                                class="form-select text-sm border border-zinc-700 bg-transparent rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            <option class="border border-zinc-700 bg-transparent appearance-none text-black" value="launch">Launch (377 per sec)</option>
                            <option class="border border-zinc-700 bg-transparent text-black" value="handy">Handy (432 per sec)</option>
                            <option class="border border-zinc-700 bg-transparent text-black" [ngValue]="200">Slow (200 per sec)</option>
                            <option class="border border-zinc-700 bg-transparent text-black" [ngValue]="300">Medium (300 per sec)</option>
                            <option class="border border-zinc-700 bg-transparent text-black" [ngValue]="500">Fast (500 per sec)</option>
                        </select>
                    </div>
                </div>

                <!-- Half Speed Options -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="flex items-center">
                        <input
                                type="checkbox"
                                id="removeShortPauses"
                                [(ngModel)]="halfSpeedOptions.removeShortPauses"
                                class="form-checkbox h-4 w-4 text-blue-600">
                        <label for="removeShortPauses" class="ml-2 text-sm">Remove Short Pauses</label>
                    </div>

                    <div class="flex items-center">
                        <input
                                type="checkbox"
                                id="matchFirstDownstroke"
                                [(ngModel)]="halfSpeedOptions.matchFirstDownstroke"
                                class="form-checkbox h-4 w-4 text-blue-600">
                        <label for="matchFirstDownstroke" class="ml-2 text-sm">Match First Downstroke</label>
                    </div>

                    <div class="flex items-center">
                        <input
                                type="checkbox"
                                id="matchGroupEndPosition"
                                [(ngModel)]="halfSpeedOptions.matchGroupEndPosition"
                                class="form-checkbox h-4 w-4 text-blue-600">
                        <label for="matchGroupEndPosition" class="ml-2 text-sm">Match Group End Position</label>
                    </div>

                    <div class="flex items-center">
                        <input
                                type="checkbox"
                                id="resetAfterPause"
                                [(ngModel)]="halfSpeedOptions.resetAfterPause"
                                class="form-checkbox h-4 w-4 text-blue-600">
                        <label for="resetAfterPause" class="ml-2 text-sm">Reset After Pause</label>
                    </div>
                </div>
            </div>

            <!-- Position Tab -->
            <div *ngIf="activeTab === 'position'" class="space-y-4">
                <div>
                    <h3 class="text-sm font-medium mb-2">Position Range</h3>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-xs mb-1">Min (0-100)</label>
                            <input
                                    type="number"
                                    [(ngModel)]="positionRange.min"
                                    min="0"
                                    max="100"
                                    class="w-full form-input text-sm border border-zinc-700 bg-transparent rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-xs mb-1">Max (0-100)</label>
                            <input
                                    type="number"
                                    [(ngModel)]="positionRange.max"
                                    min="0"
                                    max="100"
                                    class="w-full form-input text-sm border border-zinc-700 bg-transparent rounded-md shadow-sm">
                        </div>
                    </div>
                    <button
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors text-sm font-medium"
                            (click)="applyRemapPositions()">
                        Apply Range
                    </button>
                </div>
            </div>

            <!-- Timing Tab -->
            <div *ngIf="activeTab === 'offset'" class="space-y-4">
                <div>
                    <h3 class="text-sm font-medium mb-2">Time Offset (ms)</h3>
                    <div class="flex items-center space-x-3 mb-3">
                        <input
                                type="number"
                                [(ngModel)]="timeOffset"
                                class="form-input text-sm border border-zinc-700 bg-transparent rounded-md shadow-sm"
                                placeholder="Offset in ms">
                        <span class="text-xs">
              (positive: delay, negative: advance)
            </span>
                    </div>
                    <button
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors text-sm font-medium"
                            (click)="applyTimeOffset()">
                        Apply Offset
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
